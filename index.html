<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test de Felicidad</title>
  <link href="https://fonts.googleapis.com/css2?family=Karla:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Karla', sans-serif; background: white; }

    /* LOADER ‚Äî solo sobre la rueda */
    #wheel-loader {
      position: absolute; inset: 0;
      background: white;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 28px;
      z-index: 10;
      border-radius: 50%;
      transition: opacity 0.5s ease;
    }
    #wheel-loader.hide { opacity: 0; pointer-events: none; }
    .spinner-ring {
      width: 70px; height: 70px; border-radius: 50%;
      background: conic-gradient(#E74C3C, #9B59B6, #E91E63, #FF6B9D, #F39C12, #3498DB, #1ABC9C, #27AE60, #E74C3C);
      animation: spin 1.2s linear infinite;
      position: relative;
    }
    .spinner-ring::before {
      content: ''; position: absolute; inset: 5px;
      border-radius: 50%; background: white;
    }
    .spinner-ring::after {
      content: 'üòä'; position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 26px; z-index: 1;
      animation: counter-spin 1.2s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes counter-spin { to { transform: translate(-50%, -50%) rotate(-360deg); } }
    .loader-text {
      font-size: 14px; font-weight: 600; color: #333;
      text-align: center; letter-spacing: 0.3px;
    }
    .dots::after {
      content: ''; animation: dots 1.5s steps(4, end) infinite;
    }
    @keyframes dots {
      0%   { content: ''; }  25%  { content: '.'; }
      50%  { content: '..'; } 75%  { content: '...'; }
      100% { content: ''; }
    }
    .progress-bar {
      width: 140px; height: 4px; background: #f0f0f0;
      border-radius: 4px; overflow: hidden;
    }
    .progress-fill {
      height: 100%; width: 0%; border-radius: 4px;
      background: linear-gradient(90deg, #E74C3C, #9B59B6, #E91E63, #FF6B9D, #F39C12, #3498DB, #1ABC9C, #27AE60);
      background-size: 200% 100%;
      animation: fill 3s ease-in-out forwards, gradient-shift 1.5s ease infinite;
    }
    @keyframes fill { to { width: 100%; } }
    @keyframes gradient-shift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    /* HERO: rueda + texto lado a lado */
    #hero {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 40px;
      padding: 40px 40px 20px;
    }

    #wheel-wrap {
      position: relative;
      width: 100%;
      max-width: 480px;
      flex-shrink: 0;
      aspect-ratio: 1;
    }
    #wheel-wrap svg { width: 100%; height: 100%; }

    #intro-text {
      max-width: 380px;
    }
    #intro-text h1 {
      font-weight: 500;
      font-size: 2em;
      color: #1a1a1a;
      margin-bottom: 16px;
      line-height: 1.2;
    }
    #intro-text p {
      font-weight: 300;
      font-size: 1em;
      line-height: 1.8;
      color: #444;
    }
    #nombre-texto {
      font-weight: 400;
      font-size: 0.85em;
      color: #999;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    /* Divisor vertical */
    #intro-text::before {
      content: '';
      display: block;
      width: 3px;
      height: 60px;
      background: #e3a52d;
      margin-bottom: 20px;
      border-radius: 2px;
    }

    @media (max-width: 768px) {
      #hero {
        flex-direction: column;
        padding: 20px;
      }
      #wheel-wrap { max-width: 100%; }
      #intro-text { max-width: 100%; }
    }

    /* RUEDA */
    .segment-group { cursor: pointer; }
    .segment-empty { fill: #f0f0f0; stroke: white; stroke-width: 3; }
    .segment-filled { stroke: white; stroke-width: 3; transition: filter 0.3s ease; }
    .segment-group:hover .segment-filled { filter: brightness(1.15); }
    .center-circle { fill: white; }
    .icon-img { pointer-events: none; user-select: none; opacity: 0; transition: opacity 0.4s ease; }
    .icon-img.visible { opacity: 1; }
    .tooltip {
      position: fixed; background: white; color: #333; padding: 12px 16px;
      border-radius: 8px; font-size: 14px; pointer-events: none; opacity: 0;
      transition: opacity 0.3s ease; z-index: 1000; max-width: 250px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 2px solid #e0e0e0;
    }
    .tooltip.active { opacity: 1; }
    .tooltip-title { font-weight: bold; margin-bottom: 4px; font-size: 15px; }
    .tooltip-score { color: #666; font-size: 13px; }

    /* BLOQUES */
    #bloques-section { padding: 10px 40px 60px; }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
    }
    @media (max-width: 768px) {
      .grid { grid-template-columns: 1fr; }
      #bloques-section { padding: 10px 20px 40px; }
    }
    .column {
      border-radius: 18px; padding: 24px 18px;
      opacity: 0; transform: translateY(40px);
      transition: opacity 0.6s ease, transform 0.6s ease;
    }
    .column.show { opacity: 1; transform: translateY(0); }
    .column.vulnerable  { background: linear-gradient(160deg, #fce4e4, #fef2f2); }
    .column.crecimiento { background: linear-gradient(160deg, #fef3cd, #fffbeb); }
    .column.fortaleza   { background: linear-gradient(160deg, #d1fae5, #f0fdf4); }
    .column-title {
      font-weight: 400; font-size: 1em; text-transform: uppercase;
      letter-spacing: 0.12em; margin-bottom: 16px; padding-bottom: 10px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }
    .vulnerable  .column-title { color: #dc2626; }
    .crecimiento .column-title { color: #d97706; }
    .fortaleza   .column-title { color: #059669; }
    .card {
      background: white; border-radius: 14px; padding: 20px; margin-bottom: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07); transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:last-child { margin-bottom: 0; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 4px 14px rgba(0,0,0,0.1); }
    .card h3 { font-weight: 500; font-size: 0.95em; margin-bottom: 8px; }
    .card p  { font-weight: 300; font-size: 0.9em; line-height: 1.7; color: #333; }
    .empty-msg { font-weight: 300; font-size: 0.88em; color: rgba(0,0,0,0.35); text-align: center; padding: 30px 10px; }
  </style>
</head>
<body>

  <!-- HERO: rueda + texto -->
  <div id="hero">
    <div id="wheel-wrap">
      <!-- LOADER solo sobre la rueda -->
      <div id="wheel-loader">
        <div class="spinner-ring"></div>
        <div class="loader-text">Preparando tu Diagrama<span class="dots"></span></div>
        <div class="progress-bar"><div class="progress-fill"></div></div>
      </div>
      <svg id="wheel" viewBox="0 0 500 500"></svg>
      <div class="tooltip" id="tooltip">
        <div class="tooltip-title"></div>
        <div class="tooltip-score"></div>
      </div>
    </div>

    <div id="intro-text">
      <p id="nombre-texto"></p>
      <h1>Tus resultados</h1>
      <p>Cada respuesta que compartiste refleja una parte de tu historia. Con base en el Modelo de Felicidad, analizamos c√≥mo se relacionan los 8 elementos esenciales en tu vida actual. Este reporte busca darte claridad sobre tus fortalezas y mostrarte hacia d√≥nde puedes dirigir tu crecimiento personal.</p>
    </div>
  </div>

  <!-- BLOQUES -->
  <div id="bloques-section">
    <div class="grid">
      <div class="column vulnerable" id="col-vulnerable">
        <div class="column-title">√Årea Vulnerable</div>
        <div id="vulnerable-content"></div>
      </div>
      <div class="column crecimiento" id="col-crecimiento">
        <div class="column-title">Zonas de Crecimiento</div>
        <div id="crecimiento-content"></div>
      </div>
      <div class="column fortaleza" id="col-fortaleza">
        <div class="column-title">Fortaleza Actual</div>
        <div id="fortaleza-content"></div>
      </div>
    </div>
  </div>

  <script>
    const axes = [
      { name: "Est√©tica Existencial",   icon: "https://static.wixstatic.com/shapes/78c590_a8a2fefdc0f64827888353657479b65c.svg", color: "#e3a52d", key: "esteticaExistencial", start: -60, end:   0, iconSize: 72 },
      { name: "Fe y filosof√≠a de vida", icon: "https://static.wixstatic.com/shapes/78c590_62b9f44c30bb43d5b33b168c4059a2c3.svg", color: "#e3a52d", key: "feFilosofia",         start:   0, end:  60, iconSize: 52 },
      { name: "V√≠nculos vitales",       icon: "https://static.wixstatic.com/shapes/78c590_6f901ef444bb4acdbe7910e1061f9673.svg", color: "#d21744", key: "vinculosVitales",    start:  60, end: 120, iconSize: 72 },
      { name: "Bienestar emocional",    icon: "https://static.wixstatic.com/shapes/78c590_58bbd84251a948709d0532c5dcfc3051.svg", color: "#d21744", key: "bienestarEmocional", start: 120, end: 150, iconSize: 52 },
      { name: "Bienestar f√≠sico",       icon: "https://static.wixstatic.com/shapes/78c590_a807fec0f1de43f488df9dcbdf3f644f.svg", color: "#8d9438", key: "bienestarFisico",    start: 150, end: 180, iconSize: 72 },
      { name: "Presencia consciente",   icon: "https://static.wixstatic.com/shapes/78c590_ecf22bbada3b4b1eba0f3b9451d78d93.svg", color: "#8d9438", key: "presenciaConsciente",start: 180, end: 210, iconSize: 58 },
      { name: "Autoconocimiento",       icon: "https://static.wixstatic.com/shapes/78c590_4e807ff266b5441580a7493fdbd357ce.svg", color: "#66a3f4", key: "autoconocimiento",   start: 210, end: 240, iconSize: 72 },
      { name: "Trabajo con prop√≥sito",  icon: "https://static.wixstatic.com/shapes/78c590_83f9521fe52a416cb539deeacb3d3289.svg", color: "#66a3f4", key: "trabajoProp√≥sito",  start: 240, end: 300, iconSize: 52 }
    ];

    const axesList = [
      { name: 'Autoconocimiento',      key: 'autoconocimiento',    color: '#F39C12' },
      { name: 'Bienestar Emocional',   key: 'bienestarEmocional',  color: '#E91E63' },
      { name: 'Bienestar F√≠sico',      key: 'bienestarFisico',     color: '#E74C3C' },
      { name: 'Presencia Consciente',  key: 'presenciaConsciente', color: '#9B59B6' },
      { name: 'V√≠nculos Vitales',      key: 'vinculosVitales',     color: '#FF6B9D' },
      { name: 'Trabajo con Prop√≥sito', key: 'trabajoProp√≥sito',    color: '#3498DB' },
      { name: 'Est√©tica Existencial',  key: 'esteticaExistencial', color: '#1ABC9C' },
      { name: 'Fe y Filosof√≠a',        key: 'feFilosofia',         color: '#27AE60' }
    ];

    const cx = 250, cy = 250, outerR = 220, innerR = 80;
    let currentScores = {};

    window._loadStart = Date.now();

    async function loadData() {
      const params = new URLSearchParams(window.location.search);
      const recordId = params.get('record');
      if (!recordId) {
        document.getElementById('nombre-texto').textContent = 'No se encontr√≥ el registro';
        hideLoader();
        return;
      }
      try {
        const res = await fetch(`/api/dashboard?recordId=${recordId}`);
        if (!res.ok) throw new Error('Error cargando datos');
        const data = await res.json();
        renderAll(data);
      } catch (e) {
        console.error(e);
        document.getElementById('nombre-texto').textContent = 'Error cargando tu diagn√≥stico';
        hideLoader();
      }
    }

    function renderAll(data) {
      currentScores = data.scores;

      if (data.nombre) {
        document.getElementById('nombre-texto').textContent =
          `Hola, ${data.nombre} ${data.apellidos || ''}`.trim();
      }

      generateWheel();
      renderBloques(data.scores, data.analisis);

      // Esperar m√≠nimo 3 segundos antes de ocultar el loader y animar la rueda
      const MIN_LOADER_TIME = 3000;
      const elapsed = Date.now() - window._loadStart;
      const delay = Math.max(0, MIN_LOADER_TIME - elapsed);

      setTimeout(() => {
        hideLoader();
        animateSegments();
        setTimeout(() => document.getElementById('col-vulnerable').classList.add('show'), 1800);
        setTimeout(() => document.getElementById('col-crecimiento').classList.add('show'), 2200);
        setTimeout(() => document.getElementById('col-fortaleza').classList.add('show'), 2600);
      }, delay);
    }

    function hideLoader() {
      const loader = document.getElementById('wheel-loader');
      loader.classList.add('hide');
      setTimeout(() => loader.style.display = 'none', 500);
    }

    function seg(iR, oR, sA, eA) {
      const s = (sA - 90) * Math.PI / 180;
      const e = (eA - 90) * Math.PI / 180;
      const x1o = cx + oR*Math.cos(s), y1o = cy + oR*Math.sin(s);
      const x2o = cx + oR*Math.cos(e), y2o = cy + oR*Math.sin(e);
      const x1i = cx + iR*Math.cos(s), y1i = cy + iR*Math.sin(s);
      const x2i = cx + iR*Math.cos(e), y2i = cy + iR*Math.sin(e);
      const lg = (eA - sA + 360) % 360 > 180 ? 1 : 0;
      return `M ${x1o} ${y1o} A ${oR} ${oR} 0 ${lg} 1 ${x2o} ${y2o} L ${x2i} ${y2i} A ${iR} ${iR} 0 ${lg} 0 ${x1i} ${y1i} Z`;
    }

    function midIconPos(sA, eA) {
      const mid = sA + (eA - sA) / 2;
      const rad = (mid - 90) * Math.PI / 180;
      const r = innerR + (outerR - innerR) * 0.5;
      return { x: cx + r*Math.cos(rad), y: cy + r*Math.sin(rad) };
    }

    function ns(tag) { return document.createElementNS('http://www.w3.org/2000/svg', tag); }

    function generateWheel() {
      const svg = document.getElementById('wheel');
      svg.innerHTML = '';
      axes.forEach((axis, i) => {
        const g = ns('g');
        g.classList.add('segment-group');
        g.dataset.index = i;

        const empty = ns('path');
        empty.setAttribute('d', seg(innerR, outerR, axis.start, axis.end));
        empty.classList.add('segment-empty');
        g.appendChild(empty);

        const filled = ns('path');
        filled.setAttribute('d', seg(innerR, innerR + 1, axis.start, axis.end));
        filled.setAttribute('fill', axis.color);
        filled.classList.add('segment-filled');
        filled.id = `filled-${i}`;
        g.appendChild(filled);

        svg.appendChild(g);

        const pos = midIconPos(axis.start, axis.end);
        const sz = axis.iconSize;
        const img = ns('image');
        img.setAttribute('href', axis.icon);
        img.setAttribute('x', pos.x - sz/2);
        img.setAttribute('y', pos.y - sz/2);
        img.setAttribute('width', sz);
        img.setAttribute('height', sz);
        img.classList.add('icon-img');
        img.id = `icon-${i}`;
        svg.appendChild(img);
      });

      const circle = ns('circle');
      circle.setAttribute('cx', cx); circle.setAttribute('cy', cy); circle.setAttribute('r', innerR);
      circle.classList.add('center-circle');
      svg.appendChild(circle);

      setupTooltips();
    }

    function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }

    function animateSegments() {
      const duration = 1200, stagger = 120, t0 = performance.now();
      function frame(now) {
        let done = true;
        axes.forEach((axis, i) => {
          const elapsed = now - t0 - i * stagger;
          if (elapsed < 0) { done = false; return; }
          const p = Math.min(elapsed / duration, 1);
          const e = easeOutCubic(p);
          const score = currentScores[axis.key] || 0;
          const targetR = innerR + (outerR - innerR) * (score / 10);
          const curR = innerR + (targetR - innerR) * e;
          const fp = document.getElementById(`filled-${i}`);
          if (fp) fp.setAttribute('d', seg(innerR, curR, axis.start, axis.end));
          if (p > 0.5) {
            const ic = document.getElementById(`icon-${i}`);
            if (ic) ic.classList.add('visible');
          }
          if (p < 1) done = false;
        });
        if (!done) requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }

    function setupTooltips() {
      const tooltip = document.getElementById('tooltip');
      document.querySelectorAll('.segment-group').forEach(g => {
        g.addEventListener('mouseenter', e => {
          const i = parseInt(e.currentTarget.dataset.index);
          const titleEl = tooltip.querySelector('.tooltip-title');
          titleEl.textContent = axes[i].name;
          titleEl.style.color = axes[i].color;
          const score = currentScores[axes[i].key] || 0;
          tooltip.querySelector('.tooltip-score').textContent = `Puntuaci√≥n: ${score}/10`;
          tooltip.classList.add('active');
        });
        g.addEventListener('mousemove', e => {
          let l = e.clientX + 15, t = e.clientY + 15;
          if (l + 250 > window.innerWidth) l = e.clientX - 265;
          if (t + 80 > window.innerHeight) t = e.clientY - 95;
          tooltip.style.left = l + 'px'; tooltip.style.top = t + 'px';
        });
        g.addEventListener('mouseleave', () => tooltip.classList.remove('active'));
      });
    }

    function renderBloques(scores, analisis) {
      const vulnerable  = axesList.filter(a => scores[a.key] >= 1 && scores[a.key] <= 4);
      const crecimiento = axesList.filter(a => scores[a.key] >= 5 && scores[a.key] <= 7);
      const fortaleza   = axesList.filter(a => scores[a.key] >= 8 && scores[a.key] <= 10);

      function cards(items) {
        if (!items.length) return '<div class="empty-msg">Sin ejes en este rango</div>';
        return items.map(a =>
          `<div class="card"><h3 style="color:${a.color}">${a.name}</h3><p>${analisis[a.key] || 'An√°lisis pendiente...'}</p></div>`
        ).join('');
      }

      document.getElementById('vulnerable-content').innerHTML  = cards(vulnerable);
      document.getElementById('crecimiento-content').innerHTML = cards(crecimiento);
      document.getElementById('fortaleza-content').innerHTML   = cards(fortaleza);
    }

    loadData();
  </script>
</body>
</html>
